/**********************************************************************/
/*                    DO NOT MODIFY THIS HEADER                       */
/*             Swift, a Fourier spectral solver for MOOSE             */
/*                                                                    */
/*            Copyright 2024 Battelle Energy Alliance, LLC            */
/*                        ALL RIGHTS RESERVED                         */
/**********************************************************************/

#include "LBMD3Q27.h"

registerMooseObject("SwiftApp", LBMD3Q27);

InputParameters
LBMD3Q27::validParams()
{
  InputParameters params = LatticeBoltzmannStencilBase::validParams();
  params.addClassDescription("LBMD3Q27 Stencil object.");
  return params;
}

LBMD3Q27::LBMD3Q27(const InputParameters & parameters) : LatticeBoltzmannStencilBase(parameters)
{
  _q = 27;

  // LBMD3Q27 lattice
  _ex = torch::tensor(
      {0, 1, -1, 0, 0, 0, 0, 1, 1, -1, -1, 1, 1, -1, -1, 0, 0, 0, 0, 1, 1, 1, 1, -1, -1, -1, -1},
      MooseTensor::intTensorOptions());

  _ey = torch::tensor(
      {0, 0, 0, 1, -1, 0, 0, 1, -1, 1, -1, 0, 0, 0, 0, 1, 1, -1, -1, 1, -1, -1, 1, 1, -1, -1, 1},
      MooseTensor::intTensorOptions());

  _ez = torch::tensor(
      {0, 0, 0, 0, 0, 1, -1, 0, 0, 0, 0, 1, -1, 1, -1, 1, -1, 1, -1, 1, 1, -1, -1, 1, 1, -1, -1},
      MooseTensor::intTensorOptions());

  _weights = torch::tensor(
      {8.0 / 27.0,  2.0 / 27.0,  2.0 / 27.0,  2.0 / 27.0,  2.0 / 27.0,  2.0 / 27.0,  2.0 / 27.0,
       1.0 / 54.0,  1.0 / 54.0,  1.0 / 54.0,  1.0 / 54.0,  1.0 / 54.0,  1.0 / 54.0,  1.0 / 54.0,
       1.0 / 54.0,  1.0 / 54.0,  1.0 / 54.0,  1.0 / 54.0,  1.0 / 54.0,  1.0 / 216.0, 1.0 / 216.0,
       1.0 / 216.0, 1.0 / 216.0, 1.0 / 216.0, 1.0 / 216.0, 1.0 / 216.0, 1.0 / 216.0},
      MooseTensor::floatTensorOptions());

  _op = torch::tensor(
      {0, 2, 1, 4, 3, 6, 5, 10, 9, 8, 7, 14, 13, 11, 18, 17, 15, 25, 26, 23, 24, 21, 22, 19, 20},
      MooseTensor::intTensorOptions());

  // transformation matrix

  _M = torch::tensor(
      {{1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
        1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1},
       {1.0, 0.0, -1.0, 0.0, 0.0, 0.0,  1.0,  -1.0, -1.0, 1.0,  1.0,  0.0, -1.0, 0.0,
        1.0, 0.0, -1.0, 0.0, 1.0, -1.0, -1.0, 1.0,  1.0,  -1.0, -1.0, 1.0, 0},
       {0.0, 1.0, 0.0, -1.0, 0.0, 0.0, 1.0,  1.0,  -1.0, -1.0, 0.0,  1.0,  0.0, -1.0,
        0.0, 1.0, 0.0, -1.0, 1.0, 1.0, -1.0, -1.0, 1.0,  1.0,  -1.0, -1.0, 0},
       {0.0,  0.0,  0.0,  0.0,  1.0, -1.0, 0.0, 0.0, 0.0,  0.0,  1.0,  1.0,  1.0, 1.0,
        -1.0, -1.0, -1.0, -1.0, 1.0, 1.0,  1.0, 1.0, -1.0, -1.0, -1.0, -1.0, 0},
       {-1.0, -1.0, -1.0, -1.0, -1.0, -1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        0.0,  0.0,  0.0,  0.0,  1.0,  1.0,  1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -2},
       {2.0, -1.0, 2.0, -1.0, -1.0, -1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -2.0, 1.0, -2.0,
        1.0, -2.0, 1.0, -2.0, 0.0,  0.0,  0.0, 0.0, 0.0, 0.0, 0.0, 0.0,  0},
       {0.0,  1.0, 0.0,  1.0, -1.0, -1.0, 1.0, 1.0, 1.0, 1.0, -1.0, 0.0, -1.0, 0.0,
        -1.0, 0.0, -1.0, 0.0, 0.0,  0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0},
       {0.0, 0.0, 0.0, 0.0, 0.0, 0.0,  1.0, -1.0, 1.0, -1.0, 0.0, 0.0,  0.0, 0.0,
        0.0, 0.0, 0.0, 0.0, 1.0, -1.0, 1.0, -1.0, 1.0, -1.0, 1.0, -1.0, 0},
       {0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0,  0.0,  0.0,  0.0, 1.0, 0.0, -1.0,
        0.0, -1.0, 0.0, 1.0, 1.0, 1.0, -1.0, -1.0, -1.0, -1.0, 1.0, 1.0, 0},
       {0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0,  0.0, 0.0,  0.0, 1.0, 0.0,  -1.0, 0.0,
        -1.0, 0.0, 1.0, 0.0, 1.0, -1.0, -1.0, 1.0, -1.0, 1.0, 1.0, -1.0, 0},
       {-4.0, 0.0, 4.0, 0.0, 0.0, 0.0,  -1.0, 1.0, 1.0, -1.0, -1.0, 0.0, 1.0, 0.0,
        -1.0, 0.0, 1.0, 0.0, 2.0, -2.0, -2.0, 2.0, 2.0, -2.0, -2.0, 2.0, 0},
       {0.0, -4.0, 0.0, 4.0, 0.0, 0.0, -1.0, -1.0, 1.0, 1.0, 0.0,  -1.0, 0.0, 1.0,
        0.0, -1.0, 0.0, 1.0, 2.0, 2.0, -2.0, -2.0, 2.0, 2.0, -2.0, -2.0, 0},
       {0.0, 0.0, 0.0, 0.0, -4.0, 4.0, 0.0, 0.0, 0.0,  0.0,  -1.0, -1.0, -1.0, -1.0,
        1.0, 1.0, 1.0, 1.0, 2.0,  2.0, 2.0, 2.0, -2.0, -2.0, -2.0, -2.0, 0},
       {4.0,  0.0, -4.0, 0.0, 0.0, 0.0,  -2.0, 2.0, 2.0, -2.0, -2.0, 0.0, 2.0, 0.0,
        -2.0, 0.0, 2.0,  0.0, 1.0, -1.0, -1.0, 1.0, 1.0, -1.0, -1.0, 1.0, 0},
       {0.0, 4.0,  0.0, -4.0, 0.0, 0.0, -2.0, -2.0, 2.0, 2.0, 0.0,  -2.0, 0.0, 2.0,
        0.0, -2.0, 0.0, 2.0,  1.0, 1.0, -1.0, -1.0, 1.0, 1.0, -1.0, -1.0, 0},
       {0.0, 0.0, 0.0, 0.0, 4.0, -4.0, 0.0, 0.0, 0.0,  0.0,  -2.0, -2.0, -2.0, -2.0,
        2.0, 2.0, 2.0, 2.0, 1.0, 1.0,  1.0, 1.0, -1.0, -1.0, -1.0, -1.0, 0},
       {0.0,  0.0,  0.0,  0.0,  0.0, 0.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1,
        -1.0, -1.0, -1.0, -1.0, 1.0, 1.0, 1.0,  1.0,  1.0,  1.0,  1.0,  1.0,  4},
       {4.0,  4.0,  4.0,  4.0,  4.0, 4.0, -2.0, -2.0, -2.0, -2.0, -2.0, -2.0, -2.0, -2,
        -2.0, -2.0, -2.0, -2.0, 1.0, 1.0, 1.0,  1.0,  1.0,  1.0,  1.0,  1.0,  -8},
       {-4.0, 2.0,  -4.0, 2.0,  2.0, 2.0, 1.0, 1.0, 1.0, 1.0, 1.0, -2.0, 1.0, -2.0,
        1.0,  -2.0, 1.0,  -2.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,  0},
       {0.0,  -2.0, 0.0,  -2.0, 2.0, 2.0, 1.0, 1.0, 1.0, 1.0, -1.0, 0.0, -1.0, 0.0,
        -1.0, 0.0,  -1.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0},
       {0.0, 0.0, 0.0, 0.0, 0.0, 0.0,  -2.0, 2.0,  -2.0, 2.0,  0.0, 0.0,  0.0, 0.0,
        0.0, 0.0, 0.0, 0.0, 1.0, -1.0, 1.0,  -1.0, 1.0,  -1.0, 1.0, -1.0, 0},
       {0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0,  0.0,  0.0,  0.0,  0.0, -2.0, 0.0, 2.0,
        0.0, 2.0, 0.0, -2.0, 1.0, 1.0, -1.0, -1.0, -1.0, -1.0, 1.0, 1.0,  0},
       {0.0, 0.0, 0.0,  0.0, 0.0, 0.0,  0.0,  0.0, 0.0,  0.0, -2.0, 0.0,  2.0, 0.0,
        2.0, 0.0, -2.0, 0.0, 1.0, -1.0, -1.0, 1.0, -1.0, 1.0, 1.0,  -1.0, 0},
       {0.0,  0.0, 0.0, 0.0, 0.0, 0.0, 1.0, -1.0, -1.0, 1.0, -1.0, 0.0, 1.0, 0.0,
        -1.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0,  0.0,  0.0, 0.0,  0.0, 0},
       {0.0, 0.0, 0.0, 0.0,  0.0, 0.0, -1.0, -1.0, 1.0, 1.0, 0.0, 1.0, 0.0, -1.0,
        0.0, 1.0, 0.0, -1.0, 0.0, 0.0, 0.0,  0.0,  0.0, 0.0, 0.0, 0.0, 0},
       {0.0,  0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, -1.0, 1.0, -1.0,
        -1.0, 1.0, -1.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,  0},
       {0.0, 0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0,  0.0,  0.0, 0.0,  0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0, 1.0, -1.0, 1.0, -1.0, -1.0, 1.0, -1.0, 1.0, 0.0}},
      MooseTensor::floatTensorOptions());

  _M_inv = torch::linalg::inv(_M);

  // relaxation matrix
  _S = torch::diag(torch::tensor(
      {
          0.0,        0.0,        0.0,        0.0,        1.0 / 1.54, 1.0 / 1.0,  1.0 / 1.0,
          1.0 / 1.0,  1.0 / 1.0,  1.0 / 1.0,  1.0 / 1.5,  1.0 / 1.5,  1.0 / 1.5,  1.0 / 1.83,
          1.0 / 1.83, 1.0 / 1.83, 1.0 / 1.4,  1.0 / 1.61, 1.0 / 1.98, 1.0 / 1.98, 1.0 / 1.98,
          1.0 / 1.98, 1.0 / 1.98, 1.0 / 1.74, 1.0 / 1.74, 1.0 / 1.74, 1.0 / 1.74,
      },
      MooseTensor::floatTensorOptions()));

  // indices where relaxation parameter related to kinematic viscosity (i.e. shear stress) is
  // located
  _id_kinematic_visc = torch::tensor({5, 6, 7, 8, 9}, MooseTensor::intTensorOptions());
  /**
   * incoming unknown distribution functions at every face
   * the opposite faces can be determined using _op vector
   * E.g. the opposite of _top[0] is _bottom[0] = _op[top[0]]
   */
  _left = torch::tensor({1, 7, 8, 11, 12, 19, 20, 21, 22},
                        MooseTensor::intTensorOptions()); // x dir; x = 0
  _bottom = torch::tensor({3, 7, 9, 15, 16, 19, 22, 23, 26},
                          MooseTensor::intTensorOptions()); // y dir; y = 0
  _front = torch::tensor({5, 11, 13, 15, 17, 19, 20, 23, 24},
                         MooseTensor::intTensorOptions()); // z dir ; z = 0
}
